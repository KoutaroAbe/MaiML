
## MaiML編集機能 <!-- omit in toc -->

***

### 1. MaiML情報ブラウジング

#### 1.1. View-1 : MaiMLデータ一覧

- MaiML import : MaiMLファイルからのデータ取り込み
- MaiMLデータの `<document>` 関連情報を表示
  - `<uuid>`
  - `<name>`
  - `<description>`
  - `<creator>`*
  - `<vendor>`*
  - `<owner>`*
  - `<insertion>`*
  - Linkages
    - `<chain>`*
    - `<parent>`*

(*)複数データに対応

#### 1.2. View-2 ペトリネット図とノード詳細表示

ここで言うペトリネット図とは、MaiMLデータ内に定義された本来のペトリネット要素に加えて、Class層(テンプレート)の要素とInstance層(データ)の要素を同一グラフ上におけるノードとして可視化したものとなる。
また、ペトリネット要素 `arc` に加えて、Class層とInstance層についても参照関係をエッジで表現する。

ペトリネット図における各要素のUI表現を次表に示す。

|ノード種別|階層|データ型|UI形状|スタイル|
|:--:|:--:|:--:|:--:|-|
|`<place>`|Petri net|M*|円形||
|^|^|C*|五角形||
|^|^|R*|四角形||
|^|^|undefined**|円形|dashed|
|`<transition>`|^|-|縦棒||
|`<materialTemplate>`|Class|M|円形|小,中抜き|
|`<conditionTemplate>`|^|C|五角形|小,中抜き|
|`<resultTemplate>`|^|R|四角形|小,中抜き|
|`<material>`|Instance|M|円形|小,塗潰し|
|`<condition>`|^|C|五角形|小,塗潰し|
|`<result>`|^|R|四角形|小,塗潰し|

注* `<place>`ノードのデータ型については、それと参照関係`<placeRef>`でつながったClass層ノードのデータ型を付与されたノードとして扱う。但し、データ型の異なるClass層ノードから同時に参照された`<place>`があった場合、その型はシステム内部において任意に自動選択されるため、参照関係にある両ノード間で必ずしも型は一致しない。

注** `<place>`ノードに対していずれのClass層ノードからも参照されていない場合、その`<place>`のデータ型は undefined とする。このため、後述するノード新規作成機能によって追加された `<place>` は常に undefined となる。

|エッジ種別|UI形状|スタイル|
|:--:|:--:|:--:|
|`<arc>`|矢印|太|
|`<placeRef>`|矢印|細|
|`ref`|矢印|細|
|`<templateRef>`|矢印|細, dashed|
|`<instanceRef>`|矢印|細, dashed|
|SAME_UUID|矢尻なし線|細, dotted|



- 選択したノードの情報
  - MaiMLデータ型の種別 (`M` : Material, `C` : Condition, `R` : Result)
  - ノード階層 (`Petri net`, `Class`, `Instance`)
  - XML tag (`<place>`,`<transition>`, `<xxxTemplate>`, `<xxx>`, 'xxx'は任意のデータ型)
  - XML `id`属性
  - `<uuid>`
  - `<name>`
  - `<description>`

- 選択したエッジの情報
  - エッジ種別 (`<arc>`, `<placeRef>`, `<templateRef>`, `<instanceRef>`, `ref`)

- Class要素, Instance要素に対応する `<property>`
  - 階層構造の子要素にも対応する
  - 階層構造は各要素の親となる要素の要素番号を表示する形で実装


### 2. ペトリネット図の編集

#### 2.1. place,transition 追加

- MaiMLにおける `<pnml>` データへの新規placeノード、及びtransitionノードの追加
- 追加ノードへ設定する `id` 属性をユーザ入力により設定
- 設定する `id` 属性はMaiMLの中での唯一性を保証
- 追加ノードに対して `<name>`,`<description>` の情報を設定<font color=red>(!!!未実装)</font>
- 追加したノードに関してはあとから削除可能<font color=red>(!!!未実装)</font>

#### 2.2. ペトリネット図のエッジ追加/削除

ペトリネット図の中から選択した2つのノード間にエッジを追加する場合は、次表のルールに従って接続可否、および接続するエッジの種別を判定する。

|*source* \ *target*|Petri net層ノード|Class層ノード|Instance層ノード|
|:-:|:-:|:-:|:-:|
|**Petri net層ノード**|`<arc>`|-|
|**Class層ノード**|`<placeRef>`|`<templateRef>`|-|
|**Instance層ノード**|-|`ref`|`<instanceRef>`|

- エッジ追加の処理について

  1. `<arc>` 接続の場合、下記条件を満たさない操作についてはエラー判定とする。
    - `<place>`と`<transition>`との間にのみ追加が可能とする
    - 同一の `<place>` をtarget端とする `<arc>` の数は最大1本までとする
    - 2つのノード間に存在しうる `<arc>` は最大1本とする

  2. `ref` 接続の場合、接続先の両端2ノード間でデータ型が不一致となる追加操作はエラー判定とする。

  3. 追加するエッジ(`ref`を除く)へ設定する `id` 属性はシステム内部で自動生成したものを設定する。
    - `id` はMaiMLの中での唯一性保証のため重複チェックを行い、重複する場合はエラー判定とする。

- エッジ削除の処理について

  - Class層ノードに接続された全ての `<placeRef>` を削除した状態はMaiML仕様に反するが編集自体は可能とする。
  - Instance層ノードに接続された `ref` を削除した状態はMaiML仕様に反するが編集自体は可能とする。
  - `<placeRef>`が存在しない`<place>`ノードが生じる場合はデータ型は未定とせず、UI表示上は元のデータ型を維持する。<font color=red>(!!!要確認)</font>

- エッジ編集全般における注意点

  - データ型の異なる Class - Petri net ノード間の`<placeRef>`接続は可能とするが、新たに接続される`<place>`のデータ型はUI表示上は元のデータ型を維持する。<font color=red>(!!!要確認)</font>
  - MaiMLに元から存在していたエッジを削除後、本ツールで再度同一ノード間にエッジを追加した場合は MaiML データ中の元の`id`やその他属性情報を維持する。
    - (元のMaiML中のエッジ情報とUI編集データ中のエッジ情報の差分を新規MaiMLファイルへ反映する)


### 3. MaiMLファイル出力

#### 3.1. UUID設定機能
(前バージョン実装済み)
- `<document>` 階層の `<uuid>` 情報設定
  - 既存データを破棄して新規に自動生成

#### 3.2. XML署名機能
(前バージョン実装済み)
- `<document>` 階層の `<ds:Signature>` 情報設定
  - XML名前空間 `xmlns:ds="http://www.w3.org/2000/09/xmldsig#"` とする
  - MaiML出力毎に署名データを生成して設定し、検証可能とする
  - 署名に用いる秘密鍵をアプリインストール時に設定(毎回の署名において同一の鍵)

#### 3.3. MaiMLファイル改定への対応
- `<document>` 階層の `<parent><uuid>` 情報設定
  - 編集元MaiMLの `<document><uuid>` を取得して設定
- `<document>` 階層の `<parent><hash>` 情報設定
  - 編集元MaiMLの `<document><ds:Signature><ds:DigestValue>` が存在する場合は取得して設定
  - 存在しない場合は新たに編集元MaiMLから生成して設定


### 4. ペトリネット表示における同一uuidを持つ place への対応について

あるMaiMLデータ中のペトリネットにおいて、いずれかの Class層ノード(テンプレート) が他のMaiMLデータ中のペトリネットに属する Class層ノードと同一のuuidを付したノードであった場合、本アプリケーションではそのようなノードを自動的に認識し、編集対象のMaiMLに属するノードとそれ以外の関連ノードをGUI画面上で同一のペトリネット図として表示を行う機能を持つ。
![UI View-2デザイン](fig/MaiML-viewer_2023-1.png)

以下に機能の詳細を示す。

#### 4.1. 同一uuidを持つ情報に関する定義

MaiML形式において、本アプリケーションでペトリネット図として表示対象となるノードの中でuuid情報を持つノードには、Class層(テンプレート)要素とInstance層(実際の計測分析データ)要素の2種類のノードがあり、それぞれのノードに個別に一意のuuidが付与されている。本アプリケーションにおいて同一uuidを持つ情報として扱うのは、この中のClass層ノードのみとする（具体的なXML要素は下記）。
- \<conditionTemplate\>
- \<materialTemplate\>
- \<resultTemplate\>

そして、あるMaiMLデータに属する place に存在するいずれかのテンプレート要素のuuidが、別のMaiMLデータに属する place に存在するいずれかのテンプレート要素のuuidと一致する場合、それら2つの place ノードは同一uuid情報を持つ関係性として取り扱うこととする。

#### 4.2. 同一uuidを持つ place のネットワーク表現

前記の基準によって同一uuidを持つノードとして判定された2つのノード間には、本アプリケーション上のネットワークDB情報において接続(edge)情報を作成する。この接続は、ペトリネットにおける `<arc>` やその他の接続とは異なるため、区別のために `SAME_UUID` ラベルを付与し、方向性のない接続として扱う。

このようにして、ネットワークDB上の接続情報はペトリネットにおける `<arc>` やその他の接続情報に加えて、前記の `SAME_UUID` 接続が混在した形で存在する。本アプリケーションにおけるペトリネット表示の際は、ユーザが選択したMaiML内のペトリネットに加え、この `SAME_UUID` も合わせて何らかの形で接続構成されたノード群を同一のネットワーク図として表示する。但し、利便性とデータ検索効率の観点から、編集対象となるMaiMLを起点として接続関係をたどる際に通過する `SAME_UUID` 接続数の上限を1本とする。

表示要素の選択方法を具体的に示すと、下記いずれかの条件にあてはまるノードと接続のみ表示要素とする。

1. 選択したMaiMLに属するノード
2. 1における各ノードと `SAME_UUID` 接続が存在する外部MaiMLに属するノード
3. 2で該当したノードからペトリネットによる接続（`<arc>`とその他参照関係）のみを辿って到達できるノード
4. 1から3に該当する全てのノードのうちの任意の2ノード間に存在する接続(`<arc>`とその他参照関係, および`SAME_UUID`)

#### 4.3. 各ノードの所属するMaiMLに関するUI上の取り扱い

前項で記した機能により、ペトリネット編集UI画面には編集開始時にユーザが編集対象MaiMLとして選択したデータ以外に、他のMaiMLデータに属するペトリネット要素も同時に表示される場合もあるが、そのときも原則として編集対象MaiMLに属するペトリネット要素が編集操作の対象となる。このため、UI画面上においては編集対象とそれ以外のネットワーク要素を区別可能な表示スタイルとする。但し、UI表示中の要素であっても、編集対象とは異なるMaiMLに属するペトリネット要素の操作については、情報表示のみ可能となり、エッジ追加や削除等の改変操作は不可能である。

以上を踏まえ、具体的には下記に示す編集操作が可能なシステムとする。

- 新規ノード追加 (**`Add node`**)
  - 追加ノードは編集対象MaiMLに属するノードとして生成
- 新規エッジ追加 (**`Create connection`**)
  - エッジで接続する2ノードが編集対象MaiMLに属する場合は可
  - 編集対象以外のMaiMLに属するノード間エッジは不可
- 既存エッジ削除 (**`Delete connection`**)
  - 編集対象MaiMLのエッジを削除可能
  - 編集対象以外のMaiMLに属するエッジについては情報表示のみであり削除不可
